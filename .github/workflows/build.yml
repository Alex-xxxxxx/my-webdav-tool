name: Build SmartWebDAV Exe (Robust)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 1. Install Dependencies (å¼ºåˆ¶å®‰è£…ä¾èµ–)
      run: |
        python -m pip install --upgrade pip
        # ç›´æ¥å¼ºåˆ¶å®‰è£…æ‰€æœ‰éœ€è¦çš„åº“ï¼Œä¸å†ä¾èµ– requirements.txtï¼Œé˜²æ­¢æ¼æ–‡ä»¶
        pip install flask requests pystray pillow pyinstaller

    - name: 2. Find and Check Python File (æŸ¥æ‰¾å¹¶æ£€æŸ¥ä»£ç )
      run: |
        # è‡ªåŠ¨æŸ¥æ‰¾ä»“åº“é‡Œçš„ç¬¬ä¸€ä¸ª .py æ–‡ä»¶ï¼ˆå¿½ç•¥æ–‡ä»¶åå·®å¼‚ï¼‰
        $pyFile = Get-ChildItem -Filter *.py | Select-Object -First 1
        
        if ($null -eq $pyFile) {
            Write-Error "âŒ è‡´å‘½é”™è¯¯: ä»“åº“é‡Œæ²¡æœ‰æ‰¾åˆ° .py æ–‡ä»¶ï¼è¯·ç¡®è®¤ä½ ä¸Šä¼ äº†ä»£ç ã€‚"
            exit 1
        }
        
        Write-Host "ğŸ” è‡ªåŠ¨é”å®šæ–‡ä»¶: $($pyFile.Name)"
        
        # === æ ¸å¿ƒé˜²å‘†æœºåˆ¶ï¼šé¢„å…ˆæ£€æŸ¥ä»£ç è¯­æ³• ===
        # å¾ˆå¤šæŠ¥é”™æ˜¯å› ä¸ºå¤åˆ¶æ—¶å¸¦å…¥äº† ```python ç¬¦å·ï¼Œè¿™ä¸€æ­¥ä¼šæå‰æ£€æµ‹å‡ºæ¥
        try {
            python -m py_compile $pyFile.Name
            Write-Host "âœ… ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼æ˜¯çº¯å‡€çš„ Python ä»£ç ã€‚"
        } catch {
            Write-Error "âŒ ä»£ç è¯­æ³•é”™è¯¯ï¼"
            Write-Error "åŸå› å¯èƒ½æ˜¯åœ¨å¤åˆ¶ç²˜è´´æ—¶ï¼ŒæŠŠç½‘é¡µä¸Šçš„ ```python æˆ–è¡Œå·ä¹Ÿå¤åˆ¶è¿›å»äº†ã€‚"
            Write-Error "è¯·åœ¨ GitHub ç¼–è¾‘è¯¥ .py æ–‡ä»¶ï¼Œåˆ é™¤ç¬¬ä¸€è¡Œæˆ–æœ€åå¤šä½™çš„ç¬¦å·ã€‚"
            exit 1
        }

        # ä¿å­˜æ–‡ä»¶åä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
        echo "PY_FILE=$($pyFile.Name)" >> $env:GITHUB_ENV

    - name: 3. Build EXE (å¼€å§‹æ‰“åŒ…)
      run: |
        # ä½¿ç”¨è‡ªåŠ¨æ‰¾åˆ°çš„æ–‡ä»¶åè¿›è¡Œæ‰“åŒ…ï¼Œå¿½ç•¥ SSL è­¦å‘Š
        pyinstaller --noconsole --onefile --hidden-import=pystray --name="SmartWebDAV" ${{ env.PY_FILE }}

    - name: 4. Upload Artifact (ä¸Šä¼ ç»“æœ)
      uses: actions/upload-artifact@v4
      with:
        name: SmartWebDAV-Windows-Exe
        path: dist/SmartWebDAV.exe
        if-no-files-found: error
