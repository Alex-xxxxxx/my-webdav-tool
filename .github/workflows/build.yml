name: Build SmartWebDAV Exe

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Debug - List Files (Check for typos)
      run: |
        echo "=== Repository Contents ==="
        Get-ChildItem -Recurse | Select-Object FullName

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 直接安装所有依赖，忽略 requirements.txt 以防缺失
        pip install flask requests pystray pillow pyinstaller

    - name: Build with PyInstaller
      run: |
        # 1. 查找 Python 文件
        $pyFile = Get-ChildItem -Filter *.py | Select-Object -First 1
        
        if ($null -eq $pyFile) {
            Write-Error "❌ Fatal Error: No .py file found! Please verify you uploaded the code."
            exit 1
        }
        
        Write-Host "✅ Found Python file: $($pyFile.Name)"
        
        # 2. 尝试打包 (即使有警告也不中断，除非严重错误)
        pyinstaller --noconsole --onefile --hidden-import=pystray --name="SmartWebDAV" $pyFile.Name
        
        # 3. 验证 exe 是否生成成功
        if (!(Test-Path "dist/SmartWebDAV.exe")) {
             Write-Error "❌ Build Failed: The .exe file was not created. Check your Python code for syntax errors!"
             exit 1
        }
        Write-Host "✅ Build Success!"

    - name: Upload Artifact (v4)
      uses: actions/upload-artifact@v4
      with:
        name: SmartWebDAV-Windows-Exe
        path: dist/SmartWebDAV.exe
        if-no-files-found: error
