import tkinter as tk
from tkinter import ttk, scrolledtext, messagebox
import threading
import requests
from flask import Flask, request, Response, stream_with_context
import logging
import json
import os
import sys
import pystray
from PIL import Image, ImageDraw

# ================= é…ç½®åŒºåŸŸ =================

CONFIG_FILE = 'webdav_config.json'
DEFAULT_CONFIG = {
    "tailscale_url": "http://192.168.100.10:5000",
    "cloudflare_url": "https://nas.example.com",
    "local_port": 8888,
    "auto_start": False
}

class AppState:
    def __init__(self):
        self.running = False
        self.config = DEFAULT_CONFIG.copy()
        self.server_thread = None

app_state = AppState()
flask_app = Flask(__name__)
# ç¦ç”¨ Flask é»˜è®¤æ—¥å¿—ï¼Œé¿å…å¹²æ‰°
log = logging.getLogger('werkzeug')
log.setLevel(logging.ERROR)

READ_METHODS = ['GET', 'HEAD', 'OPTIONS', 'PROPFIND']
HOP_BY_HOP_HEADERS = [
    'connection', 'keep-alive', 'proxy-authenticate', 
    'proxy-authorization', 'te', 'trailers', 
    'transfer-encoding', 'upgrade'
]

def log_message(message):
    if gui_instance:
        gui_instance.append_log(message)
    else:
        print(message)

def get_target_url(method, path):
    conf = app_state.config
    if method.upper() in READ_METHODS:
        base = conf.get("tailscale_url", "").rstrip('/')
        route_type = "READ (Tailscale)"
    else:
        base = conf.get("cloudflare_url", "").rstrip('/')
        route_type = "WRITE (Cloudflare)"
    
    target = f"{base}/{path}"
    if request.query_string:
        target = f"{target}?{request.query_string.decode('utf-8')}"
    return target, route_type

def clean_headers(headers):
    cleaned = {}
    for key, value in headers.items():
        if key.lower() not in HOP_BY_HOP_HEADERS and key.lower() != 'host':
            cleaned[key] = value
    return cleaned

@flask_app.route('/', defaults={'path': ''}, methods=['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PROPFIND', 'MKCOL', 'MOVE', 'COPY', 'LOCK', 'UNLOCK', 'PROPPATCH'])
@flask_app.route('/<path:path>', methods=['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PROPFIND', 'MKCOL', 'MOVE', 'COPY', 'LOCK', 'UNLOCK', 'PROPPATCH'])
def proxy(path):
    method = request.method
    target_url, route_type = get_target_url(method, path)
    incoming_headers = clean_headers(request.headers)
    
    # å¼ºåˆ¶ä¼ªè£… User-Agentï¼Œé˜²æ­¢ NAS æ‹¦æˆª
    if 'User-Agent' not in incoming_headers:
        incoming_headers['User-Agent'] = 'SmartWebDAV/Debug'

    try:
        # verify=False å¿½ç•¥ SSL è¯ä¹¦éªŒè¯ï¼Œé˜²æ­¢ HTTPS è¿æ¥æŠ¥é”™
        resp = requests.request(
            method=method,
            url=target_url,
            headers=incoming_headers,
            data=request.stream,
            cookies=request.cookies,
            allow_redirects=False,
            stream=True,
            verify=False 
        )

        status_code = resp.status_code
        
        # === æ ¸å¿ƒè°ƒè¯•æ—¥å¿— ===
        if status_code >= 400:
            log_message(f"âŒ [{status_code}] {method} -> {target_url} (Fail)")
        elif status_code == 207: # WebDAV å¤šçŠ¶æ€æˆåŠŸ
            log_message(f"âœ… [207] {method} /{path} (Success)")
        else:
            log_message(f"âœ… [{status_code}] {method} /{path} (OK)")
        # ===================

        excluded_headers = HOP_BY_HOP_HEADERS + ['content-encoding', 'content-length', 'transfer-encoding', 'connection']
        headers = [
            (name, value) for (name, value) in resp.headers.items()
            if name.lower() not in excluded_headers
        ]

        return Response(
            stream_with_context(resp.iter_content(chunk_size=4096)),
            status=status_code,
            headers=headers
        )

    except Exception as e:
        log_message(f"ğŸš¨ è¿æ¥é”™è¯¯: {str(e)}")
        return Response(f"Proxy Error: {str(e)}", status=502)

def run_flask():
    try:
        # ç¦ç”¨ urllib3 çš„ SSL è­¦å‘Š
        requests.packages.urllib3.disable_warnings()
        port = int(app_state.config.get("local_port", 8888))
        log_message(f"æœåŠ¡å¯åŠ¨ä¸­... ç›‘å¬ç«¯å£: {port}")
        flask_app.run(host='127.0.0.1', port=port, threaded=True, use_reloader=False)
    except Exception as e:
        log_message(f"å¯åŠ¨å¤±è´¥: {e}")

class SmartGatewayGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("æ™ºèƒ½ç½‘å…³ (è°ƒè¯•ç‰ˆ)")
        self.root.geometry("550x600")
        self.root.protocol("WM_DELETE_WINDOW", self.hide_window)
        self.load_config()
        self.create_widgets()
        self.tray_icon = None
        self.setup_tray()
        if self.config.get("auto_start", False):
            self.toggle_server()

    def load_config(self):
        if os.path.exists(CONFIG_FILE):
            try:
                with open(CONFIG_FILE, 'r') as f:
                    self.config = json.load(f)
            except:
                self.config = DEFAULT_CONFIG.copy()
        else:
            self.config = DEFAULT_CONFIG.copy()
        app_state.config = self.config

    def save_config(self):
        self.config["tailscale_url"] = self.ts_url_var.get()
        self.config["cloudflare_url"] = self.cf_url_var.get()
        self.config["local_port"] = self.port_var.get()
        self.config["auto_start"] = self.auto_start_var.get()
        app_state.config = self.config
        try:
            with open(CONFIG_FILE, 'w') as f:
                json.dump(self.config, f, indent=4)
            messagebox.showinfo("æˆåŠŸ", "é…ç½®å·²ä¿å­˜")
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"ä¿å­˜å¤±è´¥: {e}")

    def create_widgets(self):
        style = ttk.Style()
        style.configure("TLabel", font=("Microsoft YaHei UI", 9))
        main_frame = ttk.Frame(self.root, padding="20")
        main_frame.pack(fill=tk.BOTH, expand=True)
        ttk.Label(main_frame, text="æ™ºèƒ½åŒè·¯ WebDAV (è°ƒè¯•ç‰ˆ)", font=("Microsoft YaHei UI", 14, "bold")).pack(pady=(0, 20))
        
        form_frame = ttk.LabelFrame(main_frame, text="è·¯ç”±é…ç½®", padding="10")
        form_frame.pack(fill=tk.X, pady=5)
        
        ttk.Label(form_frame, text="ä¸‹è½½çº¿è·¯ (Tailscale URL) - å¿…é¡»èƒ½é€šè¿‡æµè§ˆå™¨æ‰“å¼€:").pack(anchor=tk.W)
        self.ts_url_var = tk.StringVar(value=self.config.get("tailscale_url"))
        ttk.Entry(form_frame, textvariable=self.ts_url_var).pack(fill=tk.X, pady=(0, 10))
        
        ttk.Label(form_frame, text="ä¸Šä¼ çº¿è·¯ (Cloudflare URL):").pack(anchor=tk.W)
        self.cf_url_var = tk.StringVar(value=self.config.get("cloudflare_url"))
        ttk.Entry(form_frame, textvariable=self.cf_url_var).pack(fill=tk.X, pady=(0, 10))
        
        port_frame = ttk.Frame(form_frame)
        port_frame.pack(fill=tk.X)
        ttk.Label(port_frame, text="æœ¬åœ°ç«¯å£:").pack(side=tk.LEFT)
        self.port_var = tk.StringVar(value=self.config.get("local_port"))
        ttk.Entry(port_frame, textvariable=self.port_var, width=10).pack(side=tk.LEFT, padx=5)
        
        self.auto_start_var = tk.BooleanVar(value=self.config.get("auto_start", False))
        ttk.Checkbutton(form_frame, text="è‡ªåŠ¨å¯åŠ¨", variable=self.auto_start_var).pack(side=tk.LEFT, padx=20)
        
        btn_frame = ttk.Frame(main_frame)
        btn_frame.pack(fill=tk.X, pady=15)
        self.start_btn = ttk.Button(btn_frame, text="å¯åŠ¨æœåŠ¡", command=self.toggle_server)
        self.start_btn.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)
        ttk.Button(btn_frame, text="ä¿å­˜é…ç½®", command=self.save_config).pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)
        
        log_frame = ttk.LabelFrame(main_frame, text="çŠ¶æ€æ—¥å¿— (å…³æ³¨ âœ… æˆ– âŒ)", padding="5")
        log_frame.pack(fill=tk.BOTH, expand=True, pady=5)
        self.log_text = scrolledtext.ScrolledText(log_frame, height=12, state='disabled', font=("Consolas", 9))
        self.log_text.pack(fill=tk.BOTH, expand=True)

    def append_log(self, msg):
        def _update():
            self.log_text.configure(state='normal')
            self.log_text.insert(tk.END, msg + "\n")
            self.log_text.see(tk.END)
            self.log_text.configure(state='disabled')
        self.root.after(0, _update)

    def toggle_server(self):
        if app_state.running:
            messagebox.showwarning("æç¤º", "éœ€é‡å¯ç¨‹åºä»¥åœæ­¢æœåŠ¡")
            return
        app_state.config["tailscale_url"] = self.ts_url_var.get()
        app_state.config["cloudflare_url"] = self.cf_url_var.get()
        app_state.config["local_port"] = self.port_var.get()
        t = threading.Thread(target=run_flask, daemon=True)
        t.start()
        app_state.running = True
        self.start_btn.config(text="è¿è¡Œä¸­...", state='disabled')
        self.append_log(">>> æœåŠ¡å·²å¯åŠ¨ï¼Œè¯·å°è¯•è¿æ¥...")

    def create_image(self):
        w, h = 64, 64
        image = Image.new('RGB', (w, h), (255, 140, 0)) # æ©™è‰²å›¾æ ‡
        dc = ImageDraw.Draw(image)
        dc.rectangle((20, 20, 44, 44), fill='white')
        return image

    def setup_tray(self):
        image = self.create_image()
        menu = pystray.Menu(pystray.MenuItem("æ˜¾ç¤º", self.show_window, default=True), pystray.MenuItem("é€€å‡º", self.quit_app))
        self.tray_icon = pystray.Icon("SmartGatewayDebug", image, "WebDAV Debug", menu)
        threading.Thread(target=self.tray_icon.run, daemon=True).start()

    def hide_window(self):
        self.root.withdraw()
    def show_window(self, icon, item):
        self.root.after(0, self.root.deiconify)
    def quit_app(self, icon, item):
        self.tray_icon.stop()
        self.root.quit()
        sys.exit()

if __name__ == '__main__':
    try:
        from ctypes import windll
        windll.shcore.SetProcessDpiAwareness(1)
    except:
        pass
    root = tk.Tk()
    gui_instance = SmartGatewayGUI(root)
    ws = root.winfo_screenwidth()
    hs = root.winfo_screenheight()
    x = (ws/2) - (550/2)
    y = (hs/2) - (600/2)
    root.geometry('+%d+%d' % (x, y))
    root.mainloop()
